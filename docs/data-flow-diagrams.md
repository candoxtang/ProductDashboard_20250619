# Data Models & Flow

This document provides visual diagrams and detailed descriptions of the data flow, event sequence, and core data models within the application.

## High-Level Data Flow

```mermaid
graph TD
    subgraph Data Generation
        A[js/data-source.js] -- Triggers --> B(Data Generation Functions);
        B -- Produces --> C{window.appData Object};
    end

    subgraph Event-Driven Communication
        C -- Dispatches --> D[dataReady Event];
        E[js/global-filters.js] -- User Interaction --> F[globalFiltersChanged Event];
    end

    subgraph UI Layer
        G[Dashboard Modules] -- Listens for --> D;
        G -- Listens for --> F;
        G -- Reads from --> C;
        G -- Renders/Updates --> H[Charts on index.html];
    end

    style C fill:#f9f,stroke:#333,stroke-width:2px
```

## Core Data Object: `window.appData`

All data generated by `js/data-source.js` is stored in the global `window.appData` object. This object is the single source of truth for the entire application. The dashboard modules read from this object, filter it, and aggregate it to render their charts.

### Main Data Models

The following is a conceptual diagram of the key data models inside `window.appData` and their relationships.

```mermaid
classDiagram
    direction LR

    class AppData {
        +configData: ConfigData
        +dailyCostData: DailyCostRecord[]
        +materialFamilyCostData: MaterialCostRecord[]
        +reworkData: ReworkRecord[]
        +reworkByMesStepData: ReworkMesRecord[]
        +productWipTrend: TrendData
        +cycleTimeData: CycleTimeRecord[]
    }

    class DailyCostRecord {
        +date: string
        +product: string
        +fab: string
        +technology: string
        +total_planned: number
        +total_actual: number
        +rework_cost: number
        +yield: number
    }

    class MaterialCostRecord {
        +date: string
        +product: string
        +fab: string
        +technology: string
        +materialFamily: string
        +plannedCost: number
        +actualCost: number
    }

    class ReworkRecord {
        +date: string
        +productFab: string
        +value: number
        +units: number
        +wip: number
    }

    class ReworkMesRecord {
        +date: string
        +productFab: string
        +step: string
        +cost: number
    }

    AppData o-- "0..*" DailyCostRecord : contains
    AppData o-- "0..*" MaterialCostRecord : contains
    AppData o-- "0..*" ReworkRecord : contains
    AppData o-- "0..*" ReworkMesRecord : contains

    DailyCostRecord "1" -- "10" MaterialCostRecord : generates
    ReworkRecord "1" -- "1..5" ReworkMesRecord : generates
```

### Model Descriptions

*   **`dailyCostData`**: This is the foundational dataset. It contains one record per product, per day. It tracks the overall planned vs. actual cost, yield, and rework costs. **This model is the primary source for most other data models.**
    *   *Example*: `{ date: "2023-10-26", product: "Product Alpha (Fab A)", total_planned: 41379, total_actual: 42810, ... }`

*   **`materialFamilyCostData`**: Generated directly from `dailyCostData`. For each daily cost record, it creates 10 records (one for each material family, like 'Substrates/Wafers' or 'Photomasks'). It breaks down the total product cost into material-specific planned and actual costs.
    *   *Example*: `{ date: "2023-10-26", product: "Product Alpha (Fab A)", materialFamily: "Substrates/Wafers", plannedCost: 5123, actualCost: 5432, ... }`

*   **`productWipTrend`**: An object formatted for a Chart.js time-series chart. It contains `labels` (dates) and `datasets`. Each dataset represents the Work-in-Progress (WIP) trend for a specific product over time.

*   **`reworkData`**: This array contains a record for each day a product experienced rework. It's calculated based on the WIP for that day.
    *   *Example*: `{ date: "2023-10-26", productFab: "Product Alpha (Fab A)", value: 5310, units: 106, wip: 480 }`

*   **`reworkByMesStepData`**: Generated from `reworkData`. Each rework event is broken down into several records, attributing the total rework cost to specific manufacturing (MES) steps.
    *   *Example*: `{ date: "2023-10-26", productFab: "Product Alpha (Fab A)", step: "Dielectric Etch (RIE/Plasma)", cost: 1593 }`

*   **`cycleTimeData`**: Contains records for simulated manufacturing lots, tracking the planned and actual time taken at each MES step. This is used for cycle time variance analysis.
    *   *Example*: `{ lotId: "lot-1", mesStep: "Wafer Cleaning", plannedTime: 120, actualTime: 125, variance: 5, ... }`

*   **`configData`**: An object containing configuration arrays used to populate the global filters, such as lists of all Fabs, Technologies, and Products.

## Application Startup Sequence

This diagram shows the sequence of events from the moment the page loads until the charts are rendered.

```mermaid
sequenceDiagram
    participant Browser
    participant DOM
    participant data-source.js
    participant Dashboard Scripts

    Browser->>DOM: Loads index.html
    DOM-->>data-source.js: Fires DOMContentLoaded
    activate data-source.js
    data-source.js->>data-source.js: initializeDataSource()
    Note right of data-source.js: Generates all mock data<br/>and populates window.appData
    data-source.js-->>DOM: Dispatches 'dataReady' event
    deactivate data-source.js
    
    DOM-->>Dashboard Scripts: Broadcasts 'dataReady' event
    activate Dashboard Scripts
    Dashboard Scripts->>DOM: Access window.appData
    Dashboard Scripts->>Dashboard Scripts: Process data and render charts
    deactivate Dashboard Scripts
```

## Global Filter Update Flow

This diagram illustrates how the application responds when a user changes a global filter.

```mermaid
sequenceDiagram
    participant User
    participant Global Filters UI
    participant global-filters.js
    participant Dashboard Scripts

    User->>Global Filters UI: Changes a filter (e.g., selects a new Fab)
    Global Filters UI->>global-filters.js: Triggers event handler
    activate global-filters.js
    global-filters.js->>global-filters.js: Updates window.globalFilters object
    global-filters.js-->>DOM: Dispatches 'globalFiltersChanged' event
    deactivate global-filters.js

    DOM-->>Dashboard Scripts: Broadcasts 'globalFiltersChanged' event
    activate Dashboard Scripts
    Dashboard Scripts->>Dashboard Scripts: Call update functions (e.g., updateAllCharts)
    Note right of Dashboard Scripts: Use window.globalFilters and<br/>date-utils to get new data<br/>and re-render charts.
    deactivate Dashboard Scripts
``` 